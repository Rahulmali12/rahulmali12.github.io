<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NDA Math - Pro Exam Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --header-h: 60px;
            --primary: #2980b9;
            --success: #27ae60;
            --danger: #c0392b;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #2c3e50;
        }

        * { box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; margin: 0; background: #f4f6f9; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- LOGIN SCREEN --- */
        #login-screen, #result-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 1000; display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
        }
        .btn-google { background: #4285F4; color: white; padding: 12px 25px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* --- EXAM INTERFACE --- */
        #exam-interface { display: none; height: 100vh; flex-direction: column; }

        /* Header */
        header {
            height: var(--header-h); background: white; border-bottom: 1px solid #ddd;
            display: flex; justify-content: space-between; align-items: center; padding: 0 20px;
        }
        .timer-box { font-size: 1.2rem; font-weight: bold; color: var(--danger); background: #fdeaea; padding: 5px 15px; border-radius: 5px; }

        /* Main Layout */
        .main-container { display: flex; flex: 1; overflow: hidden; }

        /* Question Area (Left) */
        .question-area { flex: 3; padding: 20px; overflow-y: auto; position: relative; }
        .q-header { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: bold; color: #666; }
        .q-text { font-size: 1.2rem; margin-bottom: 25px; line-height: 1.6; }
        
        .option-item {
            display: flex; align-items: center; padding: 12px; margin-bottom: 10px;
            border: 1px solid #ccc; border-radius: 5px; cursor: pointer; transition: 0.2s;
        }
        .option-item:hover { background: #f0f8ff; border-color: var(--primary); }
        .option-item.selected { background: #e1f0fa; border-color: var(--primary); font-weight: 500; }
        .radio-circle { width: 18px; height: 18px; border: 2px solid #999; border-radius: 50%; margin-right: 15px; display: flex; align-items: center; justify-content: center; }
        .option-item.selected .radio-circle { border-color: var(--primary); }
        .option-item.selected .radio-circle::after { content: ''; width: 10px; height: 10px; background: var(--primary); border-radius: 50%; }

        /* Sidebar (Right) */
        .sidebar { flex: 1; background: white; border-left: 1px solid #ddd; display: flex; flex-direction: column; min-width: 250px; }
        .profile-sec { padding: 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
        .profile-sec img { width: 40px; height: 40px; border-radius: 50%; }
        
        .palette-grid { padding: 15px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; overflow-y: auto; flex: 1; align-content: start; }
        .p-btn {
            height: 35px; width: 35px; border-radius: 50%; border: 1px solid #ccc;
            background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9rem;
        }
        /* Palette Colors */
        .p-btn.answered { background: var(--success); color: white; border-color: var(--success); }
        .p-btn.not-answered { background: var(--danger); color: white; border-color: var(--danger); }
        .p-btn.review { background: var(--primary); color: white; border-color: var(--primary); }
        .p-btn.current { border: 2px solid var(--dark); }

        /* Footer Actions */
        .exam-footer {
            height: 60px; background: white; border-top: 1px solid #ddd; padding: 0 20px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .btn { padding: 8px 20px; border-radius: 4px; border: none; cursor: pointer; font-weight: 500; font-size: 14px; }
        .btn-save { background: var(--success); color: white; }
        .btn-clear { background: #fff; border: 1px solid #ccc; }
        .btn-review { background: var(--primary); color: white; }
        .btn-submit { background: var(--danger); color: white; }

        /* Mobile Adjustments */
        @media(max-width: 768px) {
            .main-container { flex-direction: column; }
            .sidebar { height: 150px; order: -1; border-left: none; border-bottom: 1px solid #ddd; }
            .palette-grid { padding: 5px; }
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1 style="color:var(--primary); margin-bottom:10px;">NDA MATH BRAHMASTRA</h1>
        <p style="margin-bottom:30px; color:#666;">Advanced Online Testing Platform</p>
        <button class="btn-google" onclick="signIn()">
            <i class="fab fa-google"></i> Login with Google to Start
        </button>
    </div>

    <div id="exam-interface">
        <header>
            <div style="font-weight:bold;">NDA Mock Test #01</div>
            <div class="timer-box">
                <i class="fas fa-clock"></i> <span id="timer">00:00</span>
            </div>
        </header>

        <div class="main-container">
            <div class="question-area">
                <div class="q-header">
                    <span>Question No. <span id="q-num">1</span></span>
                    <span style="color: var(--success);">+2.5 Marks</span>
                    <span style="color: var(--danger); margin-left:10px;">-0.83 Marks</span>
                </div>
                
                <div id="question-content">
                    </div>

            </div>

            <div class="sidebar">
                <div class="profile-sec">
                    <img id="user-img" src="" alt="User">
                    <div>
                        <div id="user-name" style="font-weight:600; font-size:0.9rem;">Student</div>
                        <small style="color:green;">Online</small>
                    </div>
                </div>
                <div style="padding:10px; font-weight:bold; background:#eee; font-size:0.85rem;">Question Palette</div>
                <div class="palette-grid" id="palette-box">
                    </div>
                <button class="btn btn-submit" style="width:90%; margin:10px auto;" onclick="submitExam()">SUBMIT TEST</button>
            </div>
        </div>

        <div class="exam-footer">
            <div>
                <button class="btn btn-clear" onclick="clearResponse()">Clear Response</button>
                <button class="btn btn-review" onclick="markForReview()">Mark for Review</button>
            </div>
            <button class="btn btn-save" onclick="saveAndNext()">Save & Next</button>
        </div>
    </div>

    <div id="result-screen" style="display:none;">
        <h2 style="color:var(--dark);">Test Submitted Successfully!</h2>
        <div style="width: 300px; height: 300px; margin: 20px auto;">
            <canvas id="scoreChart"></canvas>
        </div>
        <h3 id="final-score">Score: 0 / 0</h3>
        <p>Rank updated on Leaderboard.</p>
        <button class="btn btn-clear" onclick="location.reload()">Back to Home</button>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyBmsqEPUnWjjb2m4g1XgEcRrxlK_dOIDfE",
        authDomain: "revento-academy.firebaseapp.com",
        projectId: "revento-academy",
        storageBucket: "revento-academy.firebasestorage.app",
        messagingSenderId: "384071300366",
        appId: "1:384071300366:web:8a95f3ec8507bc2d3b535f",
        measurementId: "G-4L8YC6J095"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();
    let currentUser = null;

    // --- QUESTION DATABASE (Add your NDA Questions Here) ---
    // Note: Use \\( ... \\) for inline math if using MathJax
    const questions = [
        {
            id: 1,
            text: "If |a| = 3, |b| = 4 and |a × b| = 10, then what is |a.b|²?",
            options: ["22", "44", "12", "144"],
            correct: 1 // Index 0,1,2,3 (So 1 means '44')
        },
        {
            id: 2,
            text: "What is the value of i^2025?",
            options: ["1", "-1", "i", "-i"],
            correct: 2 // 'i'
        },
        {
            id: 3,
            text: "The projection of vector i+j on k is:",
            options: ["1", "0", "√2", "1/2"],
            correct: 1 // '0'
        },
        // Add more questions easily here...
    ];

    // --- EXAM STATE ---
    let currentQIndex = 0;
    let userResponses = new Array(questions.length).fill(null); // Stores selected index
    let questionStatus = new Array(questions.length).fill('not-visited'); // not-visited, visited, answered, review
    let timeLeft = 15 * 60; // 15 Minutes in seconds
    let timerInterval;

    // --- LOGIN ---
    window.signIn = () => {
        signInWithPopup(auth, provider).then(async (result) => {
            currentUser = result.user;
            
            // Check if already attempted
            const docSnap = await getDoc(doc(db, "nda_scores", currentUser.uid));
            if(docSnap.exists()){
                alert("You have already attempted this test! Showing Leaderboard is disabled in this demo to focus on new exam UI.");
                // In real version, redirect to leaderboard
            }
            
            startExam();
        }).catch((error) => alert(error.message));
    }

    // --- EXAM LOGIC ---
    function startExam() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('exam-interface').style.display = 'flex';
        
        // Set User Info
        document.getElementById('user-name').innerText = currentUser.displayName;
        document.getElementById('user-img').src = currentUser.photoURL;

        // Init Palette
        renderPalette();
        loadQuestion(0);
        startTimer();
    }

    function startTimer() {
        timerInterval = setInterval(() => {
            timeLeft--;
            let m = Math.floor(timeLeft / 60);
            let s = timeLeft % 60;
            document.getElementById('timer').innerText = `${m}:${s < 10 ? '0'+s : s}`;
            
            if(timeLeft <= 0) {
                clearInterval(timerInterval);
                submitExam();
            }
        }, 1000);
        
        // Anti-Cheat (Visibility API)
        document.addEventListener("visibilitychange", () => {
            if (document.hidden) {
                alert("WARNING: Tab switching is not allowed!");
            }
        });
    }

    function renderPalette() {
        const pBox = document.getElementById('palette-box');
        pBox.innerHTML = '';
        questions.forEach((q, idx) => {
            let btn = document.createElement('div');
            btn.className = `p-btn ${questionStatus[idx]}`;
            if(idx === currentQIndex) btn.classList.add('current');
            btn.innerText = idx + 1;
            btn.onclick = () => loadQuestion(idx);
            pBox.appendChild(btn);
        });
    }

    window.loadQuestion = (index) => {
        currentQIndex = index;
        if(questionStatus[index] === 'not-visited') questionStatus[index] = 'not-answered';
        
        const q = questions[index];
        document.getElementById('q-num').innerText = index + 1;
        
        let html = `<div class="q-text">${q.text}</div>`;
        q.options.forEach((opt, optIdx) => {
            let isSelected = userResponses[index] === optIdx ? 'selected' : '';
            html += `
            <div class="option-item ${isSelected}" onclick="selectOption(${optIdx})">
                <div class="radio-circle"></div>
                <span>${opt}</span>
            </div>`;
        });
        
        document.getElementById('question-content').innerHTML = html;
        renderPalette();
    }

    window.selectOption = (optIdx) => {
        userResponses[currentQIndex] = optIdx;
        loadQuestion(currentQIndex); // Re-render to show selection
    }

    window.saveAndNext = () => {
        if(userResponses[currentQIndex] !== null) {
            questionStatus[currentQIndex] = 'answered';
        } else {
            questionStatus[currentQIndex] = 'not-answered';
        }
        
        if(currentQIndex < questions.length - 1) {
            loadQuestion(currentQIndex + 1);
        } else {
            renderPalette(); // Just update palette
        }
    }

    window.clearResponse = () => {
        userResponses[currentQIndex] = null;
        questionStatus[currentQIndex] = 'not-answered';
        loadQuestion(currentQIndex);
    }

    window.markForReview = () => {
        questionStatus[currentQIndex] = 'review';
        if(currentQIndex < questions.length - 1) loadQuestion(currentQIndex + 1);
        else renderPalette();
    }

    // --- SUBMISSION & RESULTS ---
    window.submitExam = async () => {
        if(!confirm("Are you sure you want to submit?")) return;
        
        clearInterval(timerInterval);
        
        // Calculate Marks
        let correct = 0;
        let wrong = 0;
        let unattempted = 0;
        
        questions.forEach((q, idx) => {
            if(userResponses[idx] === null) {
                unattempted++;
            } else if(userResponses[idx] === q.correct) {
                correct++;
            } else {
                wrong++;
            }
        });

        // NDA Formula: (Correct * 2.5) - (Wrong * 0.83)
        let totalScore = (correct * 2.5) - (wrong * 0.83);
        totalScore = totalScore.toFixed(2); // Round to 2 decimals

        // Save to Firebase
        try {
            await setDoc(doc(db, "nda_scores", currentUser.uid), {
                name: currentUser.displayName,
                score: Number(totalScore),
                photo: currentUser.photoURL,
                timestamp: new Date()
            });
        } catch(e) { console.error(e); }

        // Show Results
        document.getElementById('exam-interface').style.display = 'none';
        document.getElementById('result-screen').style.display = 'flex';
        document.getElementById('final-score').innerText = `Your Score: ${totalScore}`;

        // Render Chart
        const ctx = document.getElementById('scoreChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Correct', 'Wrong', 'Skipped'],
                datasets: [{
                    data: [correct, wrong, unattempted],
                    backgroundColor: ['#27ae60', '#c0392b', '#bdc3c7']
                }]
            }
        });
    }

</script>
</body>
</html>
