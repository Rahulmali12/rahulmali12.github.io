<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rivento Academy - NDA Math Live Test</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* --- CSS Styles (Design) --- */
        :root { --primary: #1a237e; --accent: #ff6d00; --bg: #f4f6f8; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 20px; }
        .logo { color: var(--primary); font-size: 1.8rem; font-weight: bold; }
        
        /* Login Section */
        #login-section { text-align: center; padding: 40px 0; }
        .google-btn {
            background: #4285F4; color: white; border: none; padding: 12px 24px;
            font-size: 16px; border-radius: 5px; cursor: pointer; display: inline-flex; align-items: center; gap: 10px;
        }
        .google-btn:hover { background: #357ae8; }

        /* Quiz Section */
        #quiz-section { display: none; }
        .question-card { background: #f9f9f9; padding: 15px; margin-bottom: 15px; border-radius: 8px; border-left: 4px solid var(--primary); }
        .options label { display: block; padding: 8px; cursor: pointer; }
        .options label:hover { background: #eee; }

        /* Leaderboard Section */
        #leaderboard-section { display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { background: var(--primary); color: white; padding: 10px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #ddd; }
        .rank-1 { background: #fff9c4; font-weight: bold; } /* Gold */
        .rank-2 { background: #f5f5f5; font-weight: bold; } /* Silver */
        .rank-3 { background: #ffe0b2; font-weight: bold; } /* Bronze */

        .alert { padding: 10px; background: #ffebee; color: #c62828; border-radius: 5px; margin-bottom: 15px; display: none; }
        .user-info { display: flex; align-items: center; gap: 10px; justify-content: center; margin-bottom: 20px; }
        .user-img { width: 40px; height: 40px; border-radius: 50%; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="logo">RIVENTO <span style="color:var(--accent)">ACADEMY</span></div>
        <p>NDA Math - Vector & 3D (Live Test)</p>
    </header>

    <div id="login-section">
        <h3>Login to Start Test</h3>
        <p>Security Check: One Attempt Per ID Allowed</p>
        <br>
        <button class="google-btn" onclick="signInWithGoogle()">
            <i class="fab fa-google"></i> Sign in with Google
        </button>
    </div>

    <div id="loading" style="display:none; text-align:center;">
        <i class="fas fa-spinner fa-spin fa-2x"></i>
        <p>Checking your status...</p>
    </div>

    <div id="quiz-section">
        <div class="user-info">
            <img id="user-pic" src="" class="user-img">
            <div>
                <strong id="user-name">Student</strong><br>
                <small>Attempt #1</small>
            </div>
        </div>

        <form id="quizForm">
            <div class="question-card">
                <p><strong>Q1.</strong> If vector <b>a</b> and <b>b</b> are perpendicular, then <b>a.b</b> is?</p>
                <div class="options">
                    <label><input type="radio" name="q1" value="0"> 0</label>
                    <label><input type="radio" name="q1" value="1"> 1</label>
                    <label><input type="radio" name="q1" value="-1"> -1</label>
                    <label><input type="radio" name="q1" value="inf"> Infinity</label>
                </div>
            </div>

            <div class="question-card">
                <p><strong>Q2.</strong> What is the projection of vector i+j on k?</p>
                <div class="options">
                    <label><input type="radio" name="q2" value="1"> 1</label>
                    <label><input type="radio" name="q2" value="0"> 0</label>
                    <label><input type="radio" name="q2" value="root2"> ‚àö2</label>
                    <label><input type="radio" name="q2" value="half"> 1/2</label>
                </div>
            </div>
            <button type="button" class="google-btn" style="background:var(--primary); width:100%" onclick="submitQuiz()">Submit Test & See Rank</button>
        </form>
    </div>

    <div id="leaderboard-section">
        <div id="already-msg" class="alert">
            <i class="fas fa-exclamation-circle"></i> You have already taken this test!
        </div>
        
        <div style="text-align:center;">
            <h2>üèÜ Top 20 Commanders</h2>
            <p>Live Leaderboard</p>
            <h3>Your Score: <span id="my-score" style="color:var(--accent)">-</span>/2</h3>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Cadet Name</th>
                    <th>Score</th>
                </tr>
            </thead>
            <tbody id="leaderboard-body">
                </tbody>
        </table>
    </div>
</div>

<script type="module">
  // Import functions
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // TODO: PASTE YOUR FIREBASE CONFIG HERE üëá
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY_HERE",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  let currentUser = null;

  // --- LOGIN FUNCTION ---
  window.signInWithGoogle = () => {
      signInWithPopup(auth, provider)
          .then((result) => {
              // User signed in
          }).catch((error) => {
              console.error(error);
              alert("Login Failed");
          });
  };

  // --- CHECK USER STATUS (Main Security Logic) ---
  onAuthStateChanged(auth, async (user) => {
      if (user) {
          currentUser = user;
          document.getElementById('login-section').style.display = 'none';
          document.getElementById('loading').style.display = 'block';

          // Check if user already took test in Firestore Database
          const docRef = doc(db, "nda_math_scores", user.uid);
          const docSnap = await getDoc(docRef);

          document.getElementById('loading').style.display = 'none';

          if (docSnap.exists()) {
              // Already Attempted -> Show Leaderboard directly
              showLeaderboard(docSnap.data().score);
              document.getElementById('already-msg').style.display = 'block';
          } else {
              // New User -> Show Quiz
              document.getElementById('user-name').innerText = user.displayName;
              document.getElementById('user-pic').src = user.photoURL;
              document.getElementById('quiz-section').style.display = 'block';
          }
      }
  });

  // --- SUBMIT QUIZ ---
  window.submitQuiz = async () => {
      if(!currentUser) return;

      let score = 0;
      let form = document.forms['quizForm'];
      
      // Calculate Score Logic (Manual for now)
      if(form.q1.value === '0') score++;
      if(form.q2.value === '0') score++; // Example answers

      // Security: Save to Firebase so they can't submit again
      try {
          await setDoc(doc(db, "nda_math_scores", currentUser.uid), {
              name: currentUser.displayName,
              score: score,
              timestamp: new Date()
          });
          
          showLeaderboard(score);
      } catch (e) {
          alert("Error saving score: " + e.message);
      }
  };

  // --- SHOW LEADERBOARD ---
  async function showLeaderboard(myScore) {
      document.getElementById('quiz-section').style.display = 'none';
      document.getElementById('leaderboard-section').style.display = 'block';
      document.getElementById('my-score').innerText = myScore;

      // Fetch Top 20 from Database
      const q = query(collection(db, "nda_math_scores"), orderBy("score", "desc"), limit(20));
      const querySnapshot = await getDocs(q);
      
      let tbody = document.getElementById('leaderboard-body');
      tbody.innerHTML = "";
      
      let rank = 1;
      querySnapshot.forEach((doc) => {
          let data = doc.data();
          let rowClass = rank === 1 ? 'rank-1' : (rank === 2 ? 'rank-2' : (rank === 3 ? 'rank-3' : ''));
          
          let row = `<tr class="${rowClass}">
              <td>#${rank}</td>
              <td>${data.name} ${data.name === currentUser.displayName ? '(You)' : ''}</td>
              <td>${data.score}</td>
          </tr>`;
          tbody.innerHTML += row;
          rank++;
      });
  }
</script>

</body>
</html>
